<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Unity WebGL Player | WebConvai</title>
    <link rel="shortcut icon" href="TemplateData/favicon.ico">
    <link rel="stylesheet" href="TemplateData/style.css">
    <link rel="manifest" href="manifest.webmanifest">
    <!-- ConvaiWebGLSDK.js æš‚æ—¶ç¦ç”¨ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ -->
    <!-- <script src="TemplateData/ConvaiWebGLSDK.js" onload="console.log('âœ… ConvaiWebGLSDK.js åŠ è½½æˆåŠŸ')" onerror="console.error('âŒ ConvaiWebGLSDK.js åŠ è½½å¤±è´¥')"></script> -->
  </head>
  <body>
    <div id="unity-container">
      <canvas id="unity-canvas" width=960 height=600 tabindex="-1"></canvas>
      <div id="unity-loading-bar">
        <div id="unity-logo"></div>
        <div id="unity-progress-bar-empty">
          <div id="unity-progress-bar-full"></div>
        </div>
      </div>
      <div id="unity-warning"> </div>
    </div>
    <script>
      // ç¦ç”¨ Service Worker ä»¥é¿å…ç¼“å­˜é—®é¢˜ï¼ˆå¼€å‘é˜¶æ®µï¼‰
      // window.addEventListener("load", function () {
      //   if ("serviceWorker" in navigator) {
      //     navigator.serviceWorker.register("ServiceWorker.js");
      //   }
      // });

      // ===== Unity-React æ¡¥æ¥ä»£ç  =====
      var unityInstance = null;
      var isUnityReady = false;
      var messageQueue = [];

      // ===== ç«‹å³å®šä¹‰è¯­éŸ³å‡½æ•°ï¼Œç¡®ä¿Unityèƒ½è°ƒç”¨ =====
      
      // åˆå§‹åŒ–éº¦å…‹é£ï¼ˆå…¨å±€å‡½æ•°ï¼‰
      function initMicrophone() {
        console.log('[Unity iframe] ğŸ¤ è¯­éŸ³åŠŸèƒ½å·²å°±ç»ª - å°†ä½¿ç”¨æµè§ˆå™¨åŸç”Ÿè¯­éŸ³è¯†åˆ«');
        
        // ç¡®ä¿Unity canvaså¯ä»¥æ¥æ”¶é”®ç›˜äº‹ä»¶
        var canvas = document.querySelector('#unity-canvas');
        if (canvas) {
          canvas.setAttribute('tabindex', '0');
          console.log('[Unity iframe] âœ… Unity canvaså·²é…ç½®ä¸ºå¯æ¥æ”¶é”®ç›˜äº‹ä»¶');
        }
      }
      
      // å¼€å§‹å½•åˆ¶éŸ³é¢‘å—ï¼ˆå…¨å±€å‡½æ•°ï¼‰
      function startAudioChunk() {
        console.log('[Unity iframe] ğŸ¤ startAudioChunk() è¢«è°ƒç”¨');
        console.log('[Unity iframe] ğŸ”„ ä½¿ç”¨æµè§ˆå™¨åŸç”Ÿè¯­éŸ³è¯†åˆ«ä»£æ›¿ConvaiSDK');
        
        // ä½¿ç”¨Web Speech API
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
          var SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
          window.speechRecognition = new SpeechRecognition();
          
          window.speechRecognition.continuous = false;
          window.speechRecognition.interimResults = false;
          window.speechRecognition.lang = 'zh-CN'; // æ”¯æŒä¸­æ–‡
          
          window.speechRecognition.onstart = function() {
            console.log('[Unity iframe] ğŸ¤ æµè§ˆå™¨è¯­éŸ³è¯†åˆ«å¼€å§‹');
            if (window.parent && window.parent.postMessage) {
              window.parent.postMessage({ 
                type: 'UNITY_OUTPUT', 
                payload: { 
                  type: 'voice_recording', 
                  content: 'ğŸ¤ æµè§ˆå™¨è¯­éŸ³è¯†åˆ«å·²å¼€å§‹ï¼Œè¯·è¯´è¯...', 
                  recording: true 
                } 
              }, '*');
            }
          };
          
          window.speechRecognition.onresult = function(event) {
            var transcript = event.results[0][0].transcript;
            console.log('[Unity iframe] ğŸ¯ è¯­éŸ³è¯†åˆ«ç»“æœ:', transcript);
            
            // å‘é€è¯†åˆ«ç»“æœç»™Unity
            if (window.parent && window.parent.postMessage) {
              window.parent.postMessage({ 
                type: 'UNITY_OUTPUT', 
                payload: { 
                  type: 'voice_transcript', 
                  content: transcript,
                  source: 'browser_speech_api'
                } 
              }, '*');
            }
          };
          
          window.speechRecognition.onerror = function(event) {
            console.error('[Unity iframe] âŒ è¯­éŸ³è¯†åˆ«é”™è¯¯:', event.error);
            if (window.parent && window.parent.postMessage) {
              window.parent.postMessage({ 
                type: 'UNITY_OUTPUT', 
                payload: { 
                  type: 'voice_recording', 
                  content: 'âŒ è¯­éŸ³è¯†åˆ«å‡ºé”™: ' + event.error, 
                  recording: false 
                } 
              }, '*');
            }
          };
          
          window.speechRecognition.onend = function() {
            console.log('[Unity iframe] ğŸ›‘ æµè§ˆå™¨è¯­éŸ³è¯†åˆ«ç»“æŸ');
          };
          
          // å¼€å§‹è¯†åˆ«
          window.speechRecognition.start();
          
        } else {
          console.log('[Unity iframe] âŒ æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«ï¼Œå›é€€åˆ°Té”®æç¤º');
          if (window.parent && window.parent.postMessage) {
            window.parent.postMessage({ 
              type: 'UNITY_OUTPUT', 
              payload: { 
                type: 'voice_recording', 
                content: 'ğŸ¤ è¯·ç‚¹å‡»Unityç”»é¢å¹¶æŒ‰ä½Té”®è¿›è¡Œè¯­éŸ³è¾“å…¥', 
                recording: true 
              } 
            }, '*');
          }
        }
      }
      
      // ç»“æŸå½•åˆ¶éŸ³é¢‘å—ï¼ˆå…¨å±€å‡½æ•°ï¼‰
      function endAudioChunk() {
        console.log('[Unity iframe] ğŸ›‘ endAudioChunk() è¢«è°ƒç”¨');
        
        // åœæ­¢æµè§ˆå™¨è¯­éŸ³è¯†åˆ«
        if (window.speechRecognition) {
          console.log('[Unity iframe] ğŸ›‘ åœæ­¢æµè§ˆå™¨è¯­éŸ³è¯†åˆ«');
          try {
            window.speechRecognition.stop();
          } catch (e) {
            console.log('[Unity iframe] âš ï¸ åœæ­¢è¯­éŸ³è¯†åˆ«æ—¶å‡ºé”™:', e.message);
          }
          window.speechRecognition = null;
        }
        
        // é€šçŸ¥Reactç«¯å½•åˆ¶åœæ­¢
        if (window.parent && window.parent.postMessage) {
          window.parent.postMessage({ 
            type: 'UNITY_OUTPUT', 
            payload: { 
              type: 'voice_recording', 
              content: 'ğŸ›‘ è¯­éŸ³è¯†åˆ«å·²åœæ­¢', 
              recording: false 
            } 
          }, '*');
          console.log('[Unity iframe] ğŸ›‘ å·²é€šçŸ¥Reactç«¯å½•åˆ¶åœæ­¢');
        }
      }
      
      // ç«‹å³å°†å‡½æ•°ç»‘å®šåˆ°windowå¯¹è±¡ï¼Œç¡®ä¿Unityèƒ½è°ƒç”¨
      window.initMicrophone = initMicrophone;
      window.startAudioChunk = startAudioChunk;
      window.endAudioChunk = endAudioChunk;
      
      // ä¸´æ—¶è§£å†³æ–¹æ¡ˆï¼šç›´æ¥åœ¨Moduleå¯¹è±¡ä¸Šå®šä¹‰å‡½æ•°ï¼ˆUnity WebGLæŸ¥æ‰¾è·¯å¾„ï¼‰
      if (typeof Module !== 'undefined') {
        Module.initMicrophone = initMicrophone;
        Module.startAudioChunk = startAudioChunk;
        Module.endAudioChunk = endAudioChunk;
        console.log('[Unity iframe] âœ… å‡½æ•°å·²ç»‘å®šåˆ°Moduleå¯¹è±¡');
      }
      
      // å°è¯•ç»‘å®šåˆ°å¯èƒ½çš„UnityæŸ¥æ‰¾è·¯å¾„
      if (typeof unityInstance !== 'undefined' && unityInstance.Module) {
        unityInstance.Module.initMicrophone = initMicrophone;
        unityInstance.Module.startAudioChunk = startAudioChunk;
        unityInstance.Module.endAudioChunk = endAudioChunk;
        console.log('[Unity iframe] âœ… å‡½æ•°å·²ç»‘å®šåˆ°unityInstance.Module');
      }
      
      console.log('[Unity iframe] âœ… è¯­éŸ³å‡½æ•°å·²æå‰å®šä¹‰å¹¶ç»‘å®šåˆ°å…¨å±€ä½œç”¨åŸŸ');
      console.log('[Unity iframe] ğŸ”§ éªŒè¯å‡½æ•°å¯ç”¨æ€§:');
      console.log('  - window.initMicrophone:', typeof window.initMicrophone);
      console.log('  - window.startAudioChunk:', typeof window.startAudioChunk);  
      console.log('  - window.endAudioChunk:', typeof window.endAudioChunk);

      // çˆ¶é¡µé¢ -> Unity çš„æ¶ˆæ¯ç›‘å¬å™¨
      window.addEventListener('message', function (event) {
        var data = event && event.data;
        if (!data || data.type !== 'UNITY_INPUT') {
          return;
        }
        
        var payload = typeof data.payload === 'string' ? data.payload : JSON.stringify(data.payload);
        
        if (unityInstance && typeof unityInstance.SendMessage === 'function') {
          try {
            unityInstance.SendMessage('ConvaiGRPCWebAPI', 'InjectWebInput', payload);
          } catch (error) {
            console.error('[Unity iframe] SendMessage å¤±è´¥:', error);
          }
        } else {
          messageQueue.push(payload);
        }
      });

      // Unity -> çˆ¶é¡µé¢çš„è¾“å‡ºå‡½æ•°ï¼ˆä¾› C#/.jslib è°ƒç”¨ï¼‰
      window.receiveUnityOutput = function (jsonData) {
        try {
          var payload = typeof jsonData === 'string' ? JSON.parse(jsonData) : jsonData;
          
          if (window.parent && window.parent.postMessage) {
            window.parent.postMessage({ 
              type: 'UNITY_OUTPUT', 
              payload: payload 
            }, '*');
          }
        } catch (error) {
          console.error('[Unity iframe] receiveUnityOutput è§£æå¤±è´¥:', error);
        }
      };

      // ===== è¯­éŸ³åŠŸèƒ½ - ç›´æ¥ä½¿ç”¨Unityçš„Té”®è¯­éŸ³è¾“å…¥ =====
      
      // é‡å¤çš„å‡½æ•°å®šä¹‰å·²ç§»è‡³ä¸Šæ–¹çš„å…¨å±€å‡½æ•°å£°æ˜

      // ===== è°ƒè¯•å‡½æ•° =====
      
      // æ‰‹åŠ¨æµ‹è¯•Té”®æ¨¡æ‹ŸåŠŸèƒ½
      window.testTKeySimulation = function() {
        console.log('[Unity iframe] ğŸ§ª å¼€å§‹æ‰‹åŠ¨æµ‹è¯•Té”®æ¨¡æ‹Ÿ');
        
        console.log('[Unity iframe] ğŸ§ª æ­¥éª¤1: æµ‹è¯•Té”®æŒ‰ä¸‹');
        window.startAudioChunk();
        
        setTimeout(function() {
          console.log('[Unity iframe] ğŸ§ª æ­¥éª¤2: æµ‹è¯•Té”®é‡Šæ”¾');
          window.endAudioChunk();
        }, 3000); // 3ç§’åè‡ªåŠ¨é‡Šæ”¾
        
        console.log('[Unity iframe] ğŸ§ª æµ‹è¯•å®Œæˆï¼è¯·è§‚å¯ŸUnityæ˜¯å¦æœ‰è¯­éŸ³å½•åˆ¶ååº”');
      };
      
      // æ£€æŸ¥Unity canvasçŠ¶æ€
      window.checkUnityCanvasStatus = function() {
        var canvas = document.querySelector('#unity-canvas');
        console.log('[Unity iframe] ğŸ” Unity CanvasçŠ¶æ€æ£€æŸ¥:');
        console.log('  - Canvaså…ƒç´ :', canvas);
        console.log('  - Canvaså­˜åœ¨:', !!canvas);
        console.log('  - Canvaså¯è§:', canvas ? canvas.offsetParent !== null : false);
        console.log('  - Canvas tabIndex:', canvas ? canvas.tabIndex : 'N/A');
        console.log('  - å½“å‰ç„¦ç‚¹å…ƒç´ :', document.activeElement);
        console.log('  - Canvasæœ‰ç„¦ç‚¹:', document.activeElement === canvas);
        console.log('  - Unityå®ä¾‹:', typeof unityInstance !== 'undefined' ? !!unityInstance : 'undefined');
        
        return {
          canvas: canvas,
          exists: !!canvas,
          visible: canvas ? canvas.offsetParent !== null : false,
          tabIndex: canvas ? canvas.tabIndex : null,
          hasFocus: document.activeElement === canvas,
          unityInstance: typeof unityInstance !== 'undefined' ? !!unityInstance : false
        };
      };
      
      // æ‰‹åŠ¨å‘é€é”®ç›˜äº‹ä»¶åˆ°Unity
      window.manualKeyTest = function(key, action) {
        key = key || 'T';
        action = action || 'both';
        
        var canvas = document.querySelector('#unity-canvas');
        if (!canvas) {
          console.error('[Unity iframe] âŒ æ‰¾ä¸åˆ°Unity canvas');
          return;
        }
        
        canvas.focus();
        
        if (action === 'down' || action === 'both') {
          var keyDownEvent = new KeyboardEvent('keydown', {
            key: key,
            code: 'Key' + key.toUpperCase(),
            keyCode: key.charCodeAt(0),
            bubbles: true,
            cancelable: true
          });
          
          canvas.dispatchEvent(keyDownEvent);
          console.log('[Unity iframe] ğŸ§ª æ‰‹åŠ¨å‘é€', key, 'é”®æŒ‰ä¸‹äº‹ä»¶');
        }
        
        if (action === 'up' || action === 'both') {
          setTimeout(function() {
            var keyUpEvent = new KeyboardEvent('keyup', {
              key: key,
              code: 'Key' + key.toUpperCase(),
              keyCode: key.charCodeAt(0),
              bubbles: true,
              cancelable: true
            });
            
            canvas.dispatchEvent(keyUpEvent);
            console.log('[Unity iframe] ğŸ§ª æ‰‹åŠ¨å‘é€', key, 'é”®é‡Šæ”¾äº‹ä»¶');
          }, action === 'both' ? 100 : 0);
        }
      };

      // æ·»åŠ é”™è¯¯æ•è·ï¼ŒæŠ‘åˆ¶Convai SDKé”™è¯¯
      window.addEventListener('error', function(event) {
        if (event.message && event.message.includes('Client already finished sending')) {
          console.log('[Unity iframe] ğŸ”‡ æŠ‘åˆ¶Convai SDKé”™è¯¯:', event.message);
          event.preventDefault();
          return false;
        }
        if (event.message && event.message.includes('endAudioChunk')) {
          console.log('[Unity iframe] ğŸ”‡ æŠ‘åˆ¶endAudioChunké”™è¯¯:', event.message);
          event.preventDefault();
          return false;
        }
      });

      // é‡å¤çš„å‡½æ•°å®šä¹‰å·²ç§»è‡³è„šæœ¬å¼€å¤´

      // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–è¯­éŸ³åŠŸèƒ½
      window.addEventListener('load', function() {
        console.log('[Unity iframe] é¡µé¢åŠ è½½å®Œæˆï¼Œå‡†å¤‡åˆå§‹åŒ–è¯­éŸ³åŠŸèƒ½');
        
        // å†æ¬¡éªŒè¯è¯­éŸ³å‡½æ•°å¯ç”¨æ€§ï¼ˆé¡µé¢åŠ è½½åï¼‰
        console.log('[Unity iframe] ğŸ”§ é¡µé¢åŠ è½½åéªŒè¯è¯­éŸ³å‡½æ•°:');
        console.log('  - window.initMicrophone:', typeof window.initMicrophone);
        console.log('  - window.startAudioChunk:', typeof window.startAudioChunk);  
        console.log('  - window.endAudioChunk:', typeof window.endAudioChunk);
        
        // å°è¯•å¤šæ¬¡ç»‘å®šå‡½æ•°åˆ°Unityå¯èƒ½çš„æŸ¥æ‰¾è·¯å¾„
        var bindAttempts = 0;
        var maxAttempts = 10;
        
        function tryBindToUnity() {
          bindAttempts++;
          console.log('[Unity iframe] ğŸ”„ å°è¯•ç»‘å®šå‡½æ•°åˆ°Unity (å°è¯•' + bindAttempts + '/' + maxAttempts + ')');
          
          // ç»‘å®šåˆ°å¯èƒ½çš„Unityè·¯å¾„
          if (typeof Module !== 'undefined') {
            Module.initMicrophone = initMicrophone;
            Module.startAudioChunk = startAudioChunk;
            Module.endAudioChunk = endAudioChunk;
            console.log('[Unity iframe] âœ… å‡½æ•°å·²ç»‘å®šåˆ°Module');
          }
          
          if (typeof unityInstance !== 'undefined' && unityInstance.Module) {
            unityInstance.Module.initMicrophone = initMicrophone;
            unityInstance.Module.startAudioChunk = startAudioChunk;
            unityInstance.Module.endAudioChunk = endAudioChunk;
            console.log('[Unity iframe] âœ… å‡½æ•°å·²ç»‘å®šåˆ°unityInstance.Module');
          }
          
          // å¦‚æœè¿˜æ²¡æˆåŠŸä¸”æœªè¾¾åˆ°æœ€å¤§å°è¯•æ¬¡æ•°ï¼Œç»§ç»­å°è¯•
          if (bindAttempts < maxAttempts && (typeof Module === 'undefined' || (typeof unityInstance === 'undefined' || !unityInstance.Module))) {
            setTimeout(tryBindToUnity, 500); // æ¯500mså°è¯•ä¸€æ¬¡
          } else {
            console.log('[Unity iframe] ğŸ å‡½æ•°ç»‘å®šå°è¯•å®Œæˆ');
          }
        }
        
        // å¼€å§‹å°è¯•ç»‘å®š
        tryBindToUnity();
        
        // ç«‹å³åˆå§‹åŒ–ï¼Œä¸éœ€è¦å»¶è¿Ÿ
        if (typeof window.initMicrophone === 'function') {
          window.initMicrophone();
        } else {
          console.error('[Unity iframe] âŒ initMicrophoneå‡½æ•°æœªå®šä¹‰ï¼');
        }
        
      // å»¶è¿Ÿæ³¨å†Œè°ƒè¯•å‡½æ•°åˆ°å…¨å±€
      setTimeout(function() {
        if (window.parent) {
          window.parent.testTKeySimulation = window.testTKeySimulation;
          window.parent.checkUnityCanvasStatus = window.checkUnityCanvasStatus;
          window.parent.manualKeyTest = window.manualKeyTest;
          
      // æ·»åŠ è¯­éŸ³æŒ‰é’®çŠ¶æ€æ£€æŸ¥å‡½æ•°
      window.parent.checkVoiceButtonStatus = function() {
        console.log('ğŸ” è¯­éŸ³æŒ‰é’®çŠ¶æ€æ£€æŸ¥:');
        var voiceBtn = window.parent.document.querySelector('.voice-btn');
        if (voiceBtn) {
          console.log('  - æŒ‰é’®å…ƒç´ :', voiceBtn);
          console.log('  - æŒ‰é’®ç±»å:', voiceBtn.className);
          console.log('  - æŒ‰é’®ç¦ç”¨çŠ¶æ€:', voiceBtn.disabled);
          console.log('  - æŒ‰é’®æ ‡é¢˜:', voiceBtn.title);
        } else {
          console.log('  - âŒ æ‰¾ä¸åˆ°è¯­éŸ³æŒ‰é’®');
        }
      };

      // æ·»åŠ éº¦å…‹é£æƒé™æ£€æŸ¥å‡½æ•°
      window.parent.checkMicrophonePermission = function() {
        console.log('ğŸ¤ æ£€æŸ¥éº¦å…‹é£æƒé™:');
        
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          console.log('  - âŒ æµè§ˆå™¨ä¸æ”¯æŒåª’ä½“è®¾å¤‡');
          return;
        }
        
        navigator.mediaDevices.getUserMedia({ audio: true })
          .then(function(stream) {
            console.log('  - âœ… éº¦å…‹é£æƒé™å·²è·å–');
            console.log('  - éŸ³é¢‘è½¨é“æ•°:', stream.getAudioTracks().length);
            stream.getAudioTracks().forEach(function(track, index) {
              console.log(`  - éŸ³é¢‘è½¨é“${index}:`, track.label, 'çŠ¶æ€:', track.readyState);
            });
            // åœæ­¢æµ
            stream.getTracks().forEach(track => track.stop());
          })
          .catch(function(error) {
            console.log('  - âŒ éº¦å…‹é£æƒé™è¢«æ‹’ç»æˆ–å‡ºé”™:', error);
          });
      };

      // æ·»åŠ Unityè¯­éŸ³çŠ¶æ€æ£€æŸ¥å‡½æ•°
      window.parent.checkUnityVoiceStatus = function() {
        console.log('ğŸ® æ£€æŸ¥Unityè¯­éŸ³çŠ¶æ€:');
        console.log('  - Unityå®ä¾‹å­˜åœ¨:', !!unityInstance);
        
        if (unityInstance) {
          console.log('  - Unityå®ä¾‹ç±»å‹:', typeof unityInstance);
          console.log('  - SendMessageæ–¹æ³•å­˜åœ¨:', typeof unityInstance.SendMessage === 'function');
        }
        
        // æ£€æŸ¥Convaiç›¸å…³çš„å…¨å±€å˜é‡
        console.log('  - ConvaiWebGLSDKå­˜åœ¨:', typeof window.ConvaiWebGLSDK !== 'undefined');
        console.log('  - convaiClientå­˜åœ¨:', typeof window.convaiClient !== 'undefined');
        
        // æ£€æŸ¥éŸ³é¢‘ä¸Šä¸‹æ–‡
        console.log('  - AudioContextæ”¯æŒ:', !!(window.AudioContext || window.webkitAudioContext));
        
        // å¦‚æœConvaiWebGLSDKä¸å­˜åœ¨ï¼Œå°è¯•é‡æ–°åŠ è½½
        if (typeof window.ConvaiWebGLSDK === 'undefined') {
          console.log('ğŸ”„ ConvaiWebGLSDKæœªåŠ è½½ï¼Œå°è¯•é‡æ–°åŠ è½½...');
          var script = document.createElement('script');
          script.src = 'TemplateData/ConvaiWebGLSDK.js';
          script.onload = function() {
            console.log('âœ… ConvaiWebGLSDKé‡æ–°åŠ è½½æˆåŠŸ');
            setTimeout(function() {
              console.log('  - ConvaiWebGLSDKå­˜åœ¨:', typeof window.ConvaiWebGLSDK !== 'undefined');
            }, 1000);
          };
          script.onerror = function() {
            console.error('âŒ ConvaiWebGLSDKé‡æ–°åŠ è½½å¤±è´¥');
          };
          document.head.appendChild(script);
        }
      };

      // ä¿®å¤ConvaiWebGLSDKåŠ è½½é—®é¢˜
      window.parent.fixConvaiSDK = function() {
        console.log('ğŸ”§ å°è¯•ä¿®å¤ConvaiWebGLSDKåŠ è½½é—®é¢˜...');
        
        // ç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§è„šæœ¬
        var oldScript = document.querySelector('script[src*="ConvaiWebGLSDK"]');
        if (oldScript) {
          oldScript.remove();
          console.log('ğŸ—‘ï¸ ç§»é™¤æ—§çš„ConvaiWebGLSDKè„šæœ¬');
        }
        
        // æ·»åŠ æ–°çš„è„šæœ¬
        var script = document.createElement('script');
        script.src = 'TemplateData/ConvaiWebGLSDK.js?v=' + Date.now();
        script.onload = function() {
          console.log('âœ… ConvaiWebGLSDKä¿®å¤æˆåŠŸ');
          console.log('  - ConvaiWebGLSDKå­˜åœ¨:', typeof window.ConvaiWebGLSDK !== 'undefined');
        };
        script.onerror = function() {
          console.error('âŒ ConvaiWebGLSDKä¿®å¤å¤±è´¥');
        };
        document.head.appendChild(script);
      };
          
          console.log('[Unity iframe] ğŸ§ª è°ƒè¯•å‡½æ•°å·²æ³¨å†Œåˆ°çˆ¶çª—å£');
        }
      }, 1000);
      });

      // å¤„ç†æ¶ˆæ¯é˜Ÿåˆ—
      function processMessageQueue() {
        while (messageQueue.length > 0 && unityInstance && typeof unityInstance.SendMessage === 'function') {
          var payload = messageQueue.shift();
          try {
            unityInstance.SendMessage('ConvaiGRPCWebAPI', 'InjectWebInput', payload);
          } catch (error) {
            console.error('[Unity iframe] é˜Ÿåˆ—æ¶ˆæ¯å‘é€å¤±è´¥:', error);
          }
        }
      }

      var container = document.querySelector("#unity-container");
      var canvas = document.querySelector("#unity-canvas");
      var loadingBar = document.querySelector("#unity-loading-bar");
      var progressBarFull = document.querySelector("#unity-progress-bar-full");
      var warningBanner = document.querySelector("#unity-warning");

      // Shows a temporary message banner/ribbon for a few seconds, or
      // a permanent error message on top of the canvas if type=='error'.
      // If type=='warning', a yellow highlight color is used.
      // Modify or remove this function to customize the visually presented
      // way that non-critical warnings and error messages are presented to the
      // user.
      function unityShowBanner(msg, type) {
        function updateBannerVisibility() {
          warningBanner.style.display = warningBanner.children.length ? 'block' : 'none';
        }
        var div = document.createElement('div');
        div.innerHTML = msg;
        warningBanner.appendChild(div);
        if (type == 'error') div.style = 'background: red; padding: 10px;';
        else {
          if (type == 'warning') div.style = 'background: yellow; padding: 10px;';
          setTimeout(function() {
            warningBanner.removeChild(div);
            updateBannerVisibility();
          }, 5000);
        }
        updateBannerVisibility();
      }

      var buildUrl = "Build";
      var timestamp = Date.now(); // ç¼“å­˜æ¸…é™¤æ—¶é—´æˆ³
      var loaderUrl = buildUrl + "/Sylvia.loader.js?v=" + timestamp;
      var config = {
        dataUrl: buildUrl + "/Sylvia.data?v=" + timestamp,
        frameworkUrl: buildUrl + "/Sylvia.framework.js?v=" + timestamp,
        codeUrl: buildUrl + "/Sylvia.wasm?v=" + timestamp,
        streamingAssetsUrl: "StreamingAssets",
        companyName: "DefaultCompany",
        productName: "WebConvai",
        productVersion: "0.1",
        showBanner: unityShowBanner,
      };

      // By default Unity keeps WebGL canvas render target size matched with
      // the DOM size of the canvas element (scaled by window.devicePixelRatio)
      // Set this to false if you want to decouple this synchronization from
      // happening inside the engine, and you would instead like to size up
      // the canvas DOM size and WebGL render target sizes yourself.
      // config.matchWebGLToCanvasSize = false;

      if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
        // Mobile device style: fill the whole browser client area with the game canvas:
        var meta = document.createElement('meta');
        meta.name = 'viewport';
        meta.content = 'width=device-width, height=device-height, initial-scale=1.0, user-scalable=no, shrink-to-fit=yes';
        document.getElementsByTagName('head')[0].appendChild(meta);
      }

      loadingBar.style.display = "block";

      var script = document.createElement("script");
      script.src = loaderUrl;
      script.onload = () => {
        createUnityInstance(canvas, config, (progress) => {
          progressBarFull.style.width = 100 * progress + "%";
        }).then((instance) => {
          loadingBar.style.display = "none";
          
          // ä¿å­˜å…¨å±€å®ä¾‹
          unityInstance = instance;
          isUnityReady = true;
          
          // å»¶è¿Ÿå¤„ç†æ¶ˆæ¯é˜Ÿåˆ—ï¼Œç¡®ä¿Unityå®Œå…¨å°±ç»ª
          setTimeout(function() {
            processMessageQueue();
          }, 500);
          
          // å‘çˆ¶é¡µé¢å‘é€å°±ç»ªä¿¡å·
          try {
            if (window.parent && window.parent.postMessage) {
              window.parent.postMessage({ 
                type: 'UNITY_READY', 
                payload: { ready: true } 
              }, '*');
            }
          } catch (error) {
            console.error('[Unity iframe] å‘é€UNITY_READYå¤±è´¥:', error);
          }
        }).catch((message) => {
          console.error('[Unity iframe] Unityå®ä¾‹åˆ›å»ºå¤±è´¥:', message);
          alert(message);
        });
      };
      document.body.appendChild(script);
    </script>
  </body>
</html>
