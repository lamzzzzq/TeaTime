# Convai Web v3 完整部署指南

## 🎯 部署选项概览

您可以选择以下几种部署方式：

1. **🔥 推荐：云服务器部署** - 适合正式使用，其他人可以通过链接访问
2. **🐳 Docker 部署** - 简单快捷，适合有Docker环境的用户
3. **💻 本地部署** - 适合开发和测试

## 📋 部署前准备

### 系统要求
- Node.js 16+ 
- npm 8+
- Git（用于代码管理）
- Docker（可选，用于容器化部署）

### 检查环境
```bash
node --version    # 应该 >= 16.0.0
npm --version     # 应该 >= 8.0.0
```

## 🚀 方式一：云服务器部署（推荐）

### 1. 准备云服务器

**推荐的云服务平台：**
- **阿里云ECS** - 国内访问速度快
- **腾讯云CVM** - 性价比高
- **AWS EC2** - 国际化选择
- **Vultr/DigitalOcean** - 简单易用

**服务器配置建议：**
- CPU: 1核心以上
- 内存: 1GB以上
- 存储: 20GB以上
- 操作系统: Ubuntu 20.04+ / CentOS 8+

### 2. 服务器初始设置

```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装 Node.js
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# 安装 PM2（进程管理器）
sudo npm install -g pm2

# 安装 Nginx（可选，用于反向代理）
sudo apt install nginx -y
```

### 3. 部署项目

```bash
# 克隆项目到服务器
git clone https://github.com/your-username/ConvaiWeb_v3.git
cd ConvaiWeb_v3

# 使用自动部署脚本
chmod +x scripts/deploy.sh
./scripts/deploy.sh local

# 或者手动部署
cd backend && npm install
cd ../frontend && npm install && npm run build
cd ../backend && cp -r ../frontend/build public

# 使用 PM2 启动服务
pm2 start server.js --name convai-web
pm2 startup
pm2 save
```

### 4. 配置防火墙和域名

```bash
# 开放端口 3000
sudo ufw allow 3000
sudo ufw enable

# 如果使用 Nginx 反向代理（可选）
sudo ufw allow 'Nginx Full'
```

**Nginx 配置示例：**
```nginx
server {
    listen 80;
    server_name your-domain.com;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}
```

### 5. 访问您的应用

- **直接访问**: `http://你的服务器IP:3000`
- **使用域名**: `http://your-domain.com` (如果配置了Nginx)

## 🐳 方式二：Docker 部署

### 1. 安装 Docker

```bash
# Ubuntu/Debian
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# 启动 Docker
sudo systemctl start docker
sudo systemctl enable docker
```

### 2. 构建和运行

```bash
# 使用自动脚本
./scripts/deploy.sh docker

# 或者手动操作
docker build -t convai-web-v3 .
docker run -d -p 3000:3000 --name convai-web --restart unless-stopped convai-web-v3
```

### 3. 使用 Docker Compose（推荐）

```bash
# 启动服务
docker-compose up -d

# 查看日志
docker-compose logs -f

# 停止服务
docker-compose down
```

## 💻 方式三：本地部署

### Windows 用户

```cmd
# 运行部署脚本
scripts\deploy.bat

# 或者手动操作
cd backend
npm install
cd ..\frontend
npm install
npm run build
cd ..\backend
xcopy "..\frontend\build" "public" /E /I /Y
npm start
```

### Linux/Mac 用户

```bash
# 运行部署脚本
chmod +x scripts/deploy.sh
./scripts/deploy.sh local

# 或者手动操作
cd backend && npm install
cd ../frontend && npm install && npm run build
cd ../backend && cp -r ../frontend/build public
npm start
```

## 🌐 免费云平台部署

### Vercel + Railway 组合（推荐）

**前端部署到 Vercel：**
1. 注册 [Vercel](https://vercel.com)
2. 连接 GitHub 仓库
3. 设置构建配置：
   - Framework: React
   - Root Directory: `frontend`
   - Build Command: `npm run build`
   - Output Directory: `build`

**后端部署到 Railway：**
1. 注册 [Railway](https://railway.app)
2. 连接 GitHub 仓库
3. 设置配置：
   - Root Directory: `backend`
   - Start Command: `npm start`
   - 环境变量: `PORT=3000`

### Netlify + Heroku 组合

**前端部署到 Netlify：**
1. 注册 [Netlify](https://netlify.com)
2. 连接 GitHub 仓库
3. 设置构建：
   - Base directory: `frontend`
   - Build command: `npm run build`
   - Publish directory: `frontend/build`

**后端部署到 Heroku：**
1. 注册 [Heroku](https://heroku.com)
2. 安装 Heroku CLI
3. 部署命令：
```bash
# 在后端目录
heroku create your-app-name
git subtree push --prefix backend heroku main
```

## ⚙️ 环境配置

### 后端环境变量 (env.example)
```bash
NODE_ENV=production
PORT=3000
HOST=0.0.0.0
CORS_ORIGIN=https://your-frontend-domain.com
```

### 前端环境变量 (frontend/env.example)
```bash
REACT_APP_API_URL=https://your-backend-domain.com
REACT_APP_TITLE=Convai Web Chat
```

## 🔧 常见问题解决

### Q1: Unity WebGL 文件加载失败
**解决方案：**
- 检查 Unity 构建文件是否完整
- 确认服务器 MIME 类型配置正确
- 检查 CORS 设置

### Q2: 前后端通信失败
**解决方案：**
- 检查 API_URL 配置
- 确认 CORS_ORIGIN 设置
- 检查防火墙端口开放

### Q3: 部署后性能问题
**解决方案：**
- 启用 Nginx gzip 压缩
- 配置静态文件缓存
- 使用 CDN 加速

### Q4: SSL/HTTPS 配置
**解决方案：**
```bash
# 使用 Let's Encrypt 免费证书
sudo apt install certbot python3-certbot-nginx
sudo certbot --nginx -d your-domain.com
```

## 📊 监控和维护

### 健康检查
```bash
# 检查服务状态
curl http://your-domain.com/api/health

# PM2 监控
pm2 status
pm2 logs convai-web
```

### 日志管理
```bash
# 查看应用日志
pm2 logs convai-web --lines 100

# 清理旧日志
pm2 flush
```

### 自动备份脚本
```bash
#!/bin/bash
# backup.sh
DATE=$(date +%Y%m%d_%H%M%S)
tar -czf "backup_$DATE.tar.gz" ConvaiWeb_v3/
```

## 🎉 部署完成检查清单

- [ ] 服务器正常运行
- [ ] 应用可以通过链接访问
- [ ] Unity WebGL 正常加载
- [ ] 聊天功能正常工作
- [ ] API 接口响应正常
- [ ] 防火墙配置正确
- [ ] 域名解析正确（如果使用域名）
- [ ] SSL 证书配置（如果需要 HTTPS）
- [ ] 监控和日志配置完成

## 📞 获取帮助

如果遇到问题：
1. 查看 `DEPLOYMENT_INFO.md` 文件
2. 检查应用日志
3. 访问 `/api/health` 端点检查状态
4. 参考项目 README.md

---

**🎊 恭喜！您的 Convai Web v3 应用现在可以通过链接访问了！**
